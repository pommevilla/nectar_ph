---
title: "Persistent homology of microbial communities of <i>mimulus aurantiacus</i>"
# author: "Paul Villanueva"
# date: "4/11/2019"
output: html_document
---

```{r setup.1, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, cache = TRUE, message = FALSE)
```

```{r setup.2, warning = FALSE, include = FALSE, cache = TRUE}
library(data.table)
library(ggmap)
library(ggplot2)
library(ggplotify)
library(grid)
library(gridExtra)
library(TDA)
library(TDAstats)
library(phyloseq)
library(phylosmith)
library(plotly)
library(reshape2)
library(stringr)
library(tidyverse)
library(vegan)

source('./src/utils.R')

theme_set(theme_light())

```

This is persistent homology analysis based on the study [*Dispersal enhances beta diversity in nectar microbes*](https://www.ncbi.nlm.nih.gov/pubmed/28597955) by [Rachel Vanette](http://entomology.ucdavis.edu/Faculty/Rachel_Vannette/) and [Tadashi Fukami](https://web.stanford.edu/~fukamit/). 

# Introduction

The original study by Vanette and Fukami investigated the effect of dispersal on the diversity of the microbial communities of the *Mimulus aurantiacus* flower found in Jasper Ridge Biological preserve. The 

```{r load.data}
nectar <- readRDS("./data/bacteria_phyloseq.RDS")
nectar.sample_data <- nectar@sam_data %>% 
  add_count(Treatment) %>% 
  mutate(Treatment_n = paste0(Treatment, " (", n, ")"))

if (!file.exists("./data/jrbp.map.rds"))
{
  jrbp.map <- get_map(location = c(lon = mean(nectar.sample_data$longitude), 
                                   lat = mean(nectar.sample_data$latitude)), zoom = 17, 
                      maptype = "satellite", scale = 2)
  saveRDS(jrbp.map, "./data/jrbp.map.rds")
} else {
  jrbp.map <- readRDS("./data/jrbp.map.rds")
}

```


```{r, include = FALSE, warnings = FALSE}
jrbp.plot <- ggmap(jrbp.map) + 
  geom_point(data = nectar.sample_data,
             aes(x = longitude, y = latitude, fill = Treatment_n), 
             size = 1.75, shape = 21, alpha = 0.5) +
  labs(x = "", y = "", fill = "Treatment (n)",
       title = "Sample locations (random subset)"
       ) +
  theme(axis.ticks = element_blank(), axis.text = element_blank())
```

```{r}
ggplotly(jrbp.plot, 
         tooltip = c("latitude", "longitude", "treatment"))
```

```{r}
nectar.homology <- get_homology_from_phyloseq(nectar)
plot_barcode(nectar.homology) + 
  labs(x = "Nectar") +
  # xlim(0, 4) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(),
        legend.position = "none")
```

They found...

![Test](./figs/beta_disper.png)

# Barcodes

The persistence diagrams for the bagged and caged treatments:

```{r barcode.caged.1, warning = FALSE}
barcode.caged <- plot_barcode(nectar.by_treatment.bray$Caged$hom) + 
  labs(colour = "", x = "Caged samples") +
  expand_limits(x = 1) + 
  theme(#axis.text = element_blank(), axis.ticks = element_blank(),
        legend.position = "none") +
  scale_x_continuous(breaks = c(0, 1))
```

```{r barcode.caged.2}
barcode.bagged <- plot_barcode(nectar.by_treatment.bray$Bagged$hom) + 
  labs(colour = "", x = "Bagged samples") +
  theme(#axis.text = element_blank(), axis.ticks = element_blank(),
        legend.position = "none")  +
  scale_x_continuous(breaks = c(0, 1))
```

```{r combined.barcodes}
grid.arrange(barcode.caged, barcode.bagged, ncol = 2,
             top =  "Barcode diagram of microbial communities")
```

The two diagrams above are very similar. In the first dimension, the barcodes have a similar shape, and there is a little smattering of second dimensional features. The similarity in the barcode diagrams might reflect the similarity in beta diversity between the two treatments. As shown in the figure above, the beta diversity found in the caged and bagged treatments were very similar to each other. 

Of note is that the bagged samples have noticably more 1st-dimension barcodes than the caged samples. While there could be a meaningful biological reason for this, I believe the more numerous barcodes are just due to the fact that there are more bagged samples (104) than caged samples (73).




```{r}
plot_barcode(nectar.by_treatment.bray$Exposed$hom) + 
  labs(colour = "", x = "Exposed samples", 
       title = "Barcode diagram of microbial communities") +
  theme(#axis.text = element_blank(), axis.ticks = element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks = c(0, 1))
```

What's interesting here i

# Permutation tests

```{r}
nectar.by_treatment.bray <- get_persistence_list(nectar, "Treatment")
if (!file.exists("./data/nectar.bray.perm_tests")){
  nectar.bray.perm_tests <- get_pairwise_permutation_tests(nectar.by_treatment.bray, 
                                                           iters = 1500)
  saveRDS(nectar.bray.perm_tests, "./data/nectar.bray.perm_tests")
} else {
  nectar.bray.perm_tests <- readRDS("./data/nectar.bray.perm_tests")
}
```


```{r}
get_dimension_heatmap(nectar.bray.perm_tests, dimension = 1, triangle = TRUE) +   
  labs(title = "Dimension 1", subtitle = element_blank()) +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none")
```

```{r}
get_dimension_heatmap(nectar.bray.perm_tests, dimension = 2, triangle = TRUE) + 
  labs(title = "Dimension 2", subtitle = element_blank()) +
  theme(plot.title = element_text(hjust = 0.5)) 
```
